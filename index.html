<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MemoBox Online</title>
    <style>
        /* === Globale Styles === */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 850px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f8f9fa;
            color: #343a40;
            line-height: 1.6;
        }
        h1, h2, h3, h4 {
            color: #0056b3;
            text-align: center;
            margin-bottom: 20px;
            margin-top: 30px;
            font-weight: 600;
        }
        h1 { font-size: 2.5em; margin-bottom: 30px; }
        h2 { font-size: 1.8em; }
        h3 { font-size: 1.4em; text-align: left; margin-top: 25px; color: #17a2b8; }
        h4 { font-size: 1.1em; text-align: left; margin-top: 15px; color: #6c757d; }

        /* === Container === */
        .container-box {
            background: white;
            border-radius: 12px;
            padding: 25px 30px;
            margin: 25px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #e9ecef;
        }

        /* === Buttons === */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
            display: inline-block;
            margin: 5px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .btn:active {
            transform: translateY(0px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .btn:disabled { /* Stil für deaktivierte Buttons während Laden/Speichern */
             cursor: not-allowed;
             opacity: 0.65;
        }

        /* Button-Farben */
        .btn-primary { background-color: #007bff; } .btn-primary:hover:not(:disabled) { background-color: #0056b3; }
        .btn-secondary { background-color: #6c757d; } .btn-secondary:hover:not(:disabled) { background-color: #5a6268; }
        .btn-success { background-color: #28a745; } .btn-success:hover:not(:disabled) { background-color: #218838; }
        .btn-danger { background-color: #dc3545; } .btn-danger:hover:not(:disabled) { background-color: #c82333; }
        .btn-warning { background-color: #ffc107; color: #212529; } .btn-warning:hover:not(:disabled) { background-color: #e0a800; }
        .btn-info { background-color: #17a2b8; } .btn-info:hover:not(:disabled) { background-color: #138496; }
        .btn-light { background-color: #f8f9fa; color: #212529; border: 1px solid #dee2e6; } .btn-light:hover:not(:disabled) { background-color: #e2e6ea; }
        .btn-dark { background-color: #343a40; } .btn-dark:hover:not(:disabled) { background-color: #23272b; }

        /* Button-Gruppen */
        .button-group {
            margin: 30px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }
        .controls {
            margin-top: 25px;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }

        /* === Grid für Fächer & Auswahl === */
        .item-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        @media (max-width: 768px) {
            .item-grid { grid-template-columns: repeat(3, 1fr); }
        }
         @media (max-width: 480px) {
            .item-grid { grid-template-columns: repeat(2, 1fr); }
        }

        .subject-btn {
            padding: 20px 15px;
            font-weight: bold;
            min-height: 60px;
        }
        .list-item-btn {
            width: 100%;
            background-color: #007bff;
            white-space: normal;
            word-wrap: break-word;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .list-item-btn:hover:not(:disabled) { background-color: #0056b3; }
        .question-preview-btn {
             background-color: #17a2b8;
             text-align: left;
             padding: 10px 15px;
             justify-content: flex-start;
             font-size: 15px;
             font-weight: normal;
             overflow: hidden;
             text-overflow: ellipsis;
             display: block;
             line-height: 1.4;
             min-height: 50px;
        }
        .question-preview-btn:hover:not(:disabled) { background-color: #138496; }

        /* === Formulare & Editoren === */
        input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            margin: 8px 0 18px 0;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input[type="text"]:focus {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        .editable-area {
            min-height: 120px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 12px 15px;
            margin-top: 10px;
            background-color: #fff;
            transition: border-color 0.2s, box-shadow 0.2s;
            line-height: 1.5;
            overflow: auto;
        }
        .editable-area:focus {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        /* Verhindere Bearbeiten, wenn nicht eingeloggt (visuell) */
        .editable-area:not([contenteditable="true"]) {
             background-color: #e9ecef;
             opacity: 0.7;
        }
        [contenteditable="true"]:empty:before {
            content: attr(placeholder);
            color: #6c757d;
            pointer-events: none;
            display: block;
        }

        /* === Bild Handling === */
        .image-container {
            position: relative;
            display: inline-block;
            margin: 10px 10px 5px 0;
            vertical-align: top;
            max-width: calc(100% - 10px);
        }
        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            display: block;
            background-color: #f8f9fa;
        }
        .remove-image {
            position: absolute;
            top: -12px;
            right: -12px;
            background: #dc3545;
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-weight: bold;
            line-height: 24px;
            text-align: center;
            font-size: 16px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
            z-index: 10;
        }
         .remove-image:hover { background-color: #c82333; }
        .upload-btn {
            margin-top: 10px;
            margin-right: 10px;
        }

        /* === Quiz Interface === */
        .quiz-card-area {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #ffffff;
        }
        .quiz-card-area h3 {
            margin-top: 0;
            margin-bottom: 15px;
            text-align: left;
            color: #007bff;
        }
        .quiz-content {
            min-height: 60px;
            word-wrap: break-word;
        }
        #quiz-answer-area {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px dashed #ced4da;
        }
        #quiz-progress {
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
            color: #495057;
            font-size: 1.1em;
        }
        .completion-message {
             text-align: center;
             font-size: 1.4em;
             color: #28a745;
             margin: 40px 0;
             font-weight: bold;
        }

        /* === Lade-/Feedback-Indikatoren === */
         #loading-indicator, #feedback-message {
             position: fixed;
             padding: 12px 25px;
             color: white;
             border-radius: 8px;
             z-index: 1001;
             box-shadow: 0 2px 10px rgba(0,0,0,0.2);
             opacity: 0;
             transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
             visibility: hidden;
             text-align: center;
        }
         #loading-indicator {
             top: 20px;
             right: 20px;
             background-color: rgba(0, 0, 0, 0.7);
         }
          #feedback-message {
             bottom: 20px;
             left: 50%;
             transform: translateX(-50%);
             background-color: #007bff;
         }
         #loading-indicator.visible, #feedback-message.visible {
             opacity: 1;
             visibility: visible;
         }

        /* === Hilfsklassen === */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-muted { color: #6c757d; }
        .mt-2 { margin-top: 0.5rem; }
        .mb-0 { margin-bottom: 0; }

        /* === Spezifische Button-Farben für Fächer === */
        .subject-btn.Deutsch { background-color: #dc3545; }
        .subject-btn.Mathematik { background-color: #007bff; }
        .subject-btn.Englisch { background-color: #6f42c1; }
        .subject-btn.Physik { background-color: #6c757d; }
        .subject-btn.Chemie { background-color: #fd7e14; }
        .subject-btn.Biologie { background-color: #28a745; }
        .subject-btn.Geschichte { background-color: #343a40; }
        .subject-btn.Erdkunde { background-color: #ffc107; color: #212529;}
        .subject-btn.Ethik { background-color: #20c997; }
        .subject-btn.Kunst { background-color: #e83e8c; }
        .subject-btn.Musik { background-color: #6610f2; }
        .subject-btn.Informatik { background-color: #6c757d; }

    </style>
</head>
<body>
    <h1>MemoBox Online</h1>

    <div id="loading-indicator">Lädt...</div>
    <div id="feedback-message">Nachricht</div>

    <!-- 1. Startseite: Fächer-Auswahl -->
    <div id="subject-selection" class="container-box">
        <h2>Wähle ein Fach:</h2>
        <div id="subject-grid" class="item-grid">
             <p class="text-muted text-center" style="grid-column: 1 / -1;">Lade Fächer...</p>
        </div>
         <div style="text-align: right; margin-top: 15px;">
             <button id="btn-logout" class="btn btn-sm btn-secondary hidden">Logout</button>
         </div>
    </div>

    <!-- 2. Aktionen: Eintragen/Bearbeiten/Abfragen -->
    <div id="action-selection" class="hidden container-box">
        <h2 id="current-subject">Fach: </h2>
        <div class="button-group">
            <button id="btn-add" class="btn btn-primary">Eintragen</button>
            <button id="btn-edit" class="btn btn-warning">Bearbeiten / Löschen</button>
            <button id="btn-quiz" class="btn btn-info">Abfragen</button>
            <button id="btn-back-to-subjects" class="btn btn-secondary">Zurück zur Fächerwahl</button>
        </div>
    </div>

    <!-- 3. Eintragen-Formular -->
    <div id="add-card" class="hidden container-box">
        <h2>Neue Lernkarte</h2>
        <input type="text" id="grade" placeholder="Klassenstufe (z.B. 10)" required>
        <input type="text" id="chapter" placeholder="Kapitel (z.B. 1.1 Photosynthese)" required>

        <h3>Frage:</h3>
        <div id="question-editor" class="editable-area" contenteditable="true"
             placeholder="Frage eingeben (Text oder Bild per Copy & Paste)"></div>
        <button class="btn btn-success upload-btn" onclick="document.getElementById('question-upload').click()">Bild hochladen</button>
        <input type="file" id="question-upload" class="hidden" accept="image/*">

        <h3>Antwort:</h3>
        <div id="answer-editor" class="editable-area" contenteditable="true"
             placeholder="Antwort eingeben (Text oder Bild per Copy & Paste oder Upload)"></div>
        <button class="btn btn-success upload-btn" onclick="document.getElementById('answer-upload').click()">Bild hochladen</button>
        <input type="file" id="answer-upload" class="hidden" accept="image/*">

        <div class="controls">
            <button id="btn-save" class="btn btn-success">Speichern</button>
            <button id="btn-exit-add" class="btn btn-danger">Aussteigen</button>
        </div>
    </div>

    <!-- 4. Bearbeiten/Löschen - Klassenstufen Auswahl -->
    <div id="edit-grade-selection" class="hidden container-box">
        <h2>Bearbeiten: Wähle eine Klassenstufe</h2>
        <div id="edit-grades-list" class="item-grid">
            <p class="text-muted text-center" style="grid-column: 1 / -1;">Keine Einträge für dieses Fach gefunden.</p>
        </div>
        <div class="controls">
            <button id="btn-back-to-actions-from-edit-grade" class="btn btn-secondary">Zurück</button>
        </div>
    </div>

    <!-- 5. Bearbeiten/Löschen - Kapitel Auswahl -->
    <div id="edit-chapter-selection" class="hidden container-box">
        <h2 id="edit-chapter-selection-title">Bearbeiten: Wähle ein Kapitel</h2>
        <div id="edit-chapters-list" class="item-grid">
            <p class="text-muted text-center" style="grid-column: 1 / -1;">Keine Kapitel für diese Klassenstufe gefunden.</p>
        </div>
        <div class="controls">
            <button id="btn-back-to-edit-grades" class="btn btn-secondary">Zurück zur Klassenstufe</button>
        </div>
    </div>

     <!-- 6. Bearbeiten/Löschen - Fragen Auswahl -->
    <div id="edit-question-selection" class="hidden container-box">
        <h2 id="edit-question-selection-title">Bearbeiten: Wähle eine Frage</h2>
        <div id="edit-questions-list" style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
            <p class="text-muted text-center">Keine Fragen in diesem Kapitel gefunden.</p>
        </div>
        <div class="controls">
            <button id="btn-back-to-edit-chapters" class="btn btn-secondary">Zurück zum Kapitel</button>
        </div>
    </div>

    <!-- 7. Bearbeiten/Löschen - Formular -->
    <div id="edit-card" class="hidden container-box">
        <h2>Lernkarte Bearbeiten</h2>
        <input type="text" id="edit-grade" placeholder="Klassenstufe" required>
        <input type="text" id="edit-chapter" placeholder="Kapitel" required>

        <h3>Frage:</h3>
        <div id="edit-question-editor" class="editable-area" contenteditable="true"
             placeholder="Frage bearbeiten"></div>
        <button class="btn btn-success upload-btn" onclick="document.getElementById('edit-question-upload').click()">Bild hochladen</button>
        <input type="file" id="edit-question-upload" class="hidden" accept="image/*">

        <h3>Antwort:</h3>
        <div id="edit-answer-editor" class="editable-area" contenteditable="true"
             placeholder="Antwort bearbeiten"></div>
        <button class="btn btn-success upload-btn" onclick="document.getElementById('edit-answer-upload').click()">Bild hochladen</button>
        <input type="file" id="edit-answer-upload" class="hidden" accept="image/*">

        <div class="controls">
            <div>
                <button id="btn-save-changes" class="btn btn-success">Änderungen Speichern</button>
                <button id="btn-delete-card" class="btn btn-danger">Karte Löschen</button>
            </div>
            <button id="btn-cancel-edit" class="btn btn-secondary">Zurück zur Fragenübersicht</button>
        </div>
    </div>

    <!-- 8. Abfragen - Klassenstufen Auswahl -->
    <div id="quiz-grade-selection" class="hidden container-box">
        <h2>Abfragen: Wähle eine Klassenstufe</h2>
        <div id="quiz-grades-list" class="item-grid">
            <p class="text-muted text-center" style="grid-column: 1 / -1;">Keine Einträge für dieses Fach gefunden.</p>
        </div>
        <div class="controls">
            <button id="btn-back-to-actions-from-quiz-grade" class="btn btn-secondary">Zurück</button>
        </div>
    </div>

    <!-- 9. Abfragen - Kapitel Auswahl -->
    <div id="quiz-chapter-selection" class="hidden container-box">
        <h2 id="quiz-chapter-selection-title">Abfragen: Wähle ein Kapitel</h2>
        <div id="quiz-chapters-list" class="item-grid">
             <p class="text-muted text-center" style="grid-column: 1 / -1;">Keine Kapitel für diese Klassenstufe gefunden.</p>
        </div>
        <div class="controls">
            <button id="btn-back-to-quiz-grades" class="btn btn-secondary">Zurück zur Klassenstufe</button>
        </div>
    </div>

    <!-- 10. Abfragen - Quiz Interface -->
    <div id="quiz-interface" class="hidden container-box">
        <h2>Abfrage läuft...</h2>
        <div id="quiz-progress">Karte 1 von X</div>
        <div class="quiz-card-area">
            <h3>Frage:</h3>
            <div id="quiz-question" class="quiz-content"></div>
        </div>
        <div id="quiz-answer-area" class="quiz-card-area hidden">
             <h3>Antwort:</h3>
             <div id="quiz-answer" class="quiz-content"></div>
        </div>
         <div id="quiz-completion-message" class="completion-message hidden">
             🎉 Super! Alle Karten gewusst! 🎉
         </div>
        <div class="quiz-controls button-group">
            <button id="btn-show-answer" class="btn btn-primary">Antwort anzeigen</button>
            <button id="btn-known" class="btn btn-success hidden">Gewusst 👍</button>
            <button id="btn-unknown" class="btn btn-warning hidden">Nicht gewusst 👎</button>
            <button id="btn-quit-quiz" class="btn btn-danger">Abbrechen & Zurück zur Fächerwahl</button>
            <button id="btn-back-to-subjects-after-quiz" class="btn btn-secondary hidden">Zurück zur Fächerwahl</button>
        </div>
    </div>

    <script>
        // === Globale Variablen ===
        let memoBoxData = {};
        let currentSubject = '';
        let lastGrade = '';
        let lastChapter = '';
        let selectedEditGrade = '';
        let selectedEditChapter = '';
        let currentEditingCard = null;
        let originalCardLocation = { grade: '', chapter: '' };
        let quizStack = [];
        let selectedQuizGrade = '';
        let selectedQuizChapter = '';
        let initialCardCount = 0;
        let isLoadingData = false;
        let isSavingData = false;

        // ACHTUNG: Passwort hier im Frontend ist unsicher!
        // In einer echten Anwendung sollte dies besser gehandhabt werden.
        const TEACHER_LOGIN_PASSWORD = "sesam49";

        const API_ENDPOINT = '/.netlify/functions/data';

        // === Hilfsfunktionen ===
        function showSection(sectionId) {
            const sections = [
                'subject-selection', 'action-selection', 'add-card',
                'edit-grade-selection', 'edit-chapter-selection', 'edit-question-selection', 'edit-card',
                'quiz-grade-selection', 'quiz-chapter-selection', 'quiz-interface'
            ];
            sections.forEach(id => {
                const section = document.getElementById(id);
                if (section) section.classList.add('hidden');
            });
            const activeSection = document.getElementById(sectionId);
            if (activeSection) {
                activeSection.classList.remove('hidden');
                window.scrollTo(0, 0);
                // Logout-Button nur auf Startseite anzeigen, wenn eingeloggt
                 updateLogoutButtonVisibility(sectionId === 'subject-selection');
            } else {
                console.error("Sektion nicht gefunden:", sectionId);
            }
        }

        // --- Bild Handling ---
         function insertImage(editorId, imageSrc) { /* ... unverändert ... */ }
         function setupImageUpload(uploadId, editorId) { /* ... unverändert ... */ }
         function setupPasteHandler(editorId) { /* ... unverändert ... */ }
         function getEditorContentHTML(editorId) { /* ... unverändert ... */ }
         function displayHTMLContent(elementId, htmlContent) { /* ... unverändert ... */ }
         function getPlainTextFromHTML(html) { /* ... unverändert ... */ }
         function shuffleArray(array) { /* ... unverändert ... */ }
         function cleanupEmptyStructures(subject, grade, chapter) { /* ... unverändert ... */ }

         // --- Bild Handling (Code hier zur Vollständigkeit) ---
          function insertImage(editorId, imageSrc) {
             const editor = document.getElementById(editorId);
             if (!editor || !editor.isContentEditable) return;
             const selection = window.getSelection();

             if (!selection || selection.rangeCount === 0 || !editor.contains(selection.focusNode)) {
                  editor.focus();
                  const endRange = document.createRange();
                  endRange.selectNodeContents(editor);
                  endRange.collapse(false);
                  selection.removeAllRanges();
                  selection.addRange(endRange);
             }
              const range = selection.getRangeAt(0);

             const container = document.createElement('div');
             container.className = 'image-container';
             container.contentEditable = 'false';

             const img = document.createElement('img');
             img.src = imageSrc;
             img.className = 'image-preview';

             const removeBtn = document.createElement('button');
             removeBtn.className = 'remove-image btn';
             removeBtn.innerHTML = '×';
             removeBtn.contentEditable = 'false';
             removeBtn.onclick = function(event) {
                  event.stopPropagation();
                  container.remove();
                  editor.focus();
             };

             container.appendChild(img);
             container.appendChild(removeBtn);
             range.insertNode(container);

             const space = document.createTextNode('\u00A0');
             range.setStartAfter(container);
             range.insertNode(space);
             range.setStartAfter(space);
             range.collapse(true);
             selection.removeAllRanges();
             selection.addRange(range);
             editor.focus();
         }

         function setupImageUpload(uploadId, editorId) {
             const upload = document.getElementById(uploadId);
             if (!upload) return;
             upload.addEventListener('change', function(e) {
                 if (e.target.files && e.target.files[0]) {
                     const reader = new FileReader();
                     reader.onload = function(event) {
                         insertImage(editorId, event.target.result);
                     };
                     reader.readAsDataURL(e.target.files[0]);
                     upload.value = '';
                 }
             });
         }

         function setupPasteHandler(editorId) {
              const editor = document.getElementById(editorId);
              if (!editor) return;
              editor.addEventListener('paste', function(e) {
                 if (document.activeElement !== editor || !editor.isContentEditable) return;
                 e.preventDefault();
                 const items = (e.clipboardData || window.clipboardData).items;
                 let foundImage = false;
                 for (let i = 0; i < items.length; i++) {
                     if (items[i].type.indexOf('image') !== -1) {
                         const blob = items[i].getAsFile();
                          if (blob) {
                             const reader = new FileReader();
                             reader.onload = function(event) { insertImage(editorId, event.target.result); };
                             reader.readAsDataURL(blob);
                             foundImage = true;
                             break;
                         }
                     }
                 }
                  if (!foundImage) {
                     const text = (e.clipboardData || window.clipboardData).getData('text/plain');
                     if (text) { document.execCommand('insertText', false, text); }
                  }
             });
         }

         function getEditorContentHTML(editorId) {
             const editor = document.getElementById(editorId);
             if (!editor) return '';
             const tempDiv = editor.cloneNode(true);
             tempDiv.querySelectorAll('.remove-image').forEach(btn => btn.remove());
             tempDiv.querySelectorAll('.image-container:not(:has(img))').forEach(cont => cont.remove());
             return tempDiv.innerHTML.trim();
         }

         function displayHTMLContent(elementId, htmlContent) {
             const element = document.getElementById(elementId);
             if (!element) return;
             element.innerHTML = htmlContent || '';
             element.querySelectorAll('.image-container').forEach(container => {
                 container.contentEditable = 'false';
                 const removeBtn = container.querySelector('.remove-image');
                 if(removeBtn) removeBtn.remove();
             });
             element.querySelectorAll('img').forEach(img => { img.classList.add('image-preview'); });
              if (element.isContentEditable) {
                  element.querySelectorAll('.image-container').forEach(container => {
                      if (!container.querySelector('.remove-image')) {
                          const removeBtn = document.createElement('button');
                          removeBtn.className = 'remove-image btn';
                          removeBtn.innerHTML = '×';
                          removeBtn.contentEditable = 'false';
                          removeBtn.onclick = function(event) { event.stopPropagation(); container.remove(); element.focus(); };
                          container.appendChild(removeBtn);
                      }
                  });
              }
         }

         function getPlainTextFromHTML(html) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            return tempDiv.textContent || tempDiv.innerText || "";
        }

        function shuffleArray(array) { /* ... unverändert ... */ }
         function cleanupEmptyStructures(subject, grade, chapter) { /* ... unverändert ... */ }


        // --- NEU: Login Status Management ---
        function isTeacherLoggedIn() {
            return sessionStorage.getItem('teacherLoggedIn') === 'true';
        }

        function setTeacherLoggedIn(status) {
            if (status) {
                sessionStorage.setItem('teacherLoggedIn', 'true');
            } else {
                sessionStorage.removeItem('teacherLoggedIn');
            }
            updateLogoutButtonVisibility(true); // Logout Button Status aktualisieren
        }

        function attemptTeacherLogin() {
            const enteredPassword = prompt("Bitte Lehrer-Passwort eingeben:");
            if (enteredPassword === null) { return false; } // Abbruch durch Benutzer

            // Passwort-Prüfung (unsicher im Frontend!)
            if (enteredPassword === TEACHER_LOGIN_PASSWORD) {
                setTeacherLoggedIn(true);
                showFeedback("Login erfolgreich!", "success");
                return true;
            } else {
                alert("Falsches Passwort!");
                setTeacherLoggedIn(false);
                return false;
            }
        }

        // Logout Funktion
        function logoutTeacher() {
            setTeacherLoggedIn(false);
            showFeedback("Erfolgreich ausgeloggt.", "info");
            // Ggf. zur Startseite zurückkehren, falls man woanders war
            showSection('subject-selection');
        }

        // Sichtbarkeit des Logout-Buttons steuern
        function updateLogoutButtonVisibility(isOnStartPage) {
             const logoutBtn = document.getElementById('btn-logout');
             if (!logoutBtn) return;
             if (isTeacherLoggedIn() && isOnStartPage) {
                 logoutBtn.classList.remove('hidden');
             } else {
                 logoutBtn.classList.add('hidden');
             }
        }
        // --- Ende Login Status Management ---

        // --- Backend Kommunikation (OHNE Passwort im Request Body) ---
        async function saveMemoBoxDataToServer() {
            console.log("Attempting to save data to server...");
            if (isSavingData) {
                 console.warn("Save already in progress.");
                 showFeedback("Speichervorgang läuft bereits...", "info");
                 return false;
            }
            isSavingData = true;
            setButtonsDisabled(true);
            showLoadingIndicator(true, "Speichere Daten...");

            try {
                console.log("Sending fetch POST request to:", API_ENDPOINT);
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', },
                    body: JSON.stringify({
                        // KEIN Passwort wird mehr gesendet
                        data: memoBoxData
                    }),
                });

                const responseBody = await response.text();
                console.log("Server Response Status:", response.status);
                console.log("Server Response Body:", responseBody);

                if (!response.ok) {
                    let errorData = {};
                    try { errorData = JSON.parse(responseBody); } catch (e) {}
                    let errorMsg = `Fehler ${response.status}: ${response.statusText}`;
                    if (errorData.error) { errorMsg = `Fehler: ${errorData.error}`; }
                    else if (responseBody) { errorMsg = `Serverfehler: ${responseBody}`; }
                    throw new Error(errorMsg);
                }

                console.log("Data successfully saved on server.");
                showFeedback("Daten gespeichert!", "success");
                isSavingData = false;
                setButtonsDisabled(false);
                showLoadingIndicator(false);
                return true;

            } catch (error) {
                console.error('Fehler beim Speichern der Daten:', error);
                showFeedback(`Speichern fehlgeschlagen: ${error.message}`, "error");
                isSavingData = false;
                setButtonsDisabled(false);
                showLoadingIndicator(false);
                return false;
            }
        }

        async function loadMemoBoxDataFromServer() { /* ... unverändert wie vorher ... */ }
         // --- Backend Kommunikation (Code hier zur Vollständigkeit) ---
         async function loadMemoBoxDataFromServer() {
             if (isLoadingData) return;
             isLoadingData = true;
             setButtonsDisabled(true);
             showLoadingIndicator(true, "Lade Daten...");
             console.log("Loading data from server...");

             try {
                 const response = await fetch(API_ENDPOINT); // GET
                  console.log("Load response status:", response.status);
                 if (!response.ok) {
                      const errorText = await response.text();
                      console.error("Load response error text:", errorText);
                      throw new Error(`Fehler ${response.status}: ${response.statusText}`);
                 }
                 const data = await response.json();
                 memoBoxData = data || {};
                 console.log("Data successfully loaded from server.");
                 displaySubjectButtons();
                 showSection('subject-selection');

             } catch (error) {
                 console.error('Fehler beim Laden der Daten:', error);
                 showFeedback(`Laden der Daten fehlgeschlagen: ${error.message}.`, "error");
                 memoBoxData = {};
                 displaySubjectButtons();
                 showSection('subject-selection');
             } finally {
                  isLoadingData = false;
                  setButtonsDisabled(false);
                  showLoadingIndicator(false);
             }
         }


        // --- UI Hilfsfunktionen ---
        function showLoadingIndicator(show, message = "Lädt...") { /* ... unverändert ... */ }
        function showFeedback(message, type = "info") { /* ... unverändert ... */ }
        function setButtonsDisabled(disabled) { /* ... unverändert ... */ }
         // --- UI Hilfsfunktionen (Code hier zur Vollständigkeit) ---
         function showLoadingIndicator(show, message = "Lädt...") {
             const indicator = document.getElementById('loading-indicator');
             if (!indicator) return;
             if (show) {
                 indicator.textContent = message;
                 indicator.classList.add('visible');
             } else {
                 indicator.classList.remove('visible');
             }
         }
         function showFeedback(message, type = "info") {
             const feedback = document.getElementById('feedback-message');
             if (!feedback) return;
             feedback.textContent = message;
             feedback.style.backgroundColor = type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff';
             feedback.classList.add('visible');
             setTimeout(() => { feedback.classList.remove('visible'); }, 3000);
         }
         function setButtonsDisabled(disabled) {
              const buttons = document.querySelectorAll('button.btn');
              buttons.forEach(button => { button.disabled = disabled; });
              const editors = document.querySelectorAll('.editable-area');
              editors.forEach(editor => {
                 // Nur contentEditable steuern, wenn es auch ein Editor sein soll
                 if(editor.hasAttribute('placeholder')) {
                    editor.contentEditable = !disabled;
                    editor.style.opacity = disabled ? 0.7 : 1;
                    // Sicherstellen, dass Editoren im Bearbeiten-Modus auch gesperrt werden
                    if (disabled && (editor.id === 'edit-question-editor' || editor.id === 'edit-answer-editor')) {
                       editor.contentEditable = false;
                    }
                 }
              });
         }


        // --- Event Listener Setup ---
        document.addEventListener('DOMContentLoaded', async function() {
            setupImageUpload('question-upload', 'question-editor');
            setupImageUpload('answer-upload', 'answer-editor');
            setupPasteHandler('question-editor');
            setupPasteHandler('answer-editor');
            setupImageUpload('edit-question-upload', 'edit-question-editor');
            setupImageUpload('edit-answer-upload', 'edit-answer-editor');
            setupPasteHandler('edit-question-editor');
            setupPasteHandler('edit-answer-editor');

            // Initiales Laden
            await loadMemoBoxDataFromServer();

            // Logout Button
            document.getElementById('btn-logout').addEventListener('click', logoutTeacher);

            // Navigation
            document.getElementById('btn-back-to-subjects').addEventListener('click', () => showSection('subject-selection'));

            // --- Eintragen Button ---
            document.getElementById('btn-add').addEventListener('click', function() {
                if (!isTeacherLoggedIn()) {
                    if (!attemptTeacherLogin()) { return; } // Login versuchen, bei Fehler abbrechen
                }
                // Nur wenn Login erfolgreich oder schon eingeloggt:
                document.getElementById('grade').value = lastGrade;
                document.getElementById('chapter').value = lastChapter;
                document.getElementById('question-editor').innerHTML = ''; // Leeren für neue Karte
                document.getElementById('answer-editor').innerHTML = '';
                // Sicherstellen, dass Editoren bearbeitbar sind
                document.getElementById('question-editor').contentEditable = true;
                document.getElementById('answer-editor').contentEditable = true;
                showSection('add-card');
                document.getElementById('grade').focus();
            });

            // --- Speichern Button ---
            document.getElementById('btn-save').addEventListener('click', async function() {
                 if (!isTeacherLoggedIn()) {
                     showFeedback("Nicht eingeloggt. Speichern nicht möglich.", "error");
                     return; // Verhindern, wenn nicht eingeloggt
                 }
                const grade = document.getElementById('grade').value.trim();
                const chapter = document.getElementById('chapter').value.trim();
                const questionHTML = getEditorContentHTML('question-editor');
                const answerHTML = getEditorContentHTML('answer-editor');

                if (!grade || !chapter) { alert('Bitte Klassenstufe und Kapitel eingeben!'); return; }
                const questionIsEmpty = !getPlainTextFromHTML(questionHTML) && !questionHTML.includes('<img');
                const answerIsEmpty = !getPlainTextFromHTML(answerHTML) && !answerHTML.includes('<img');
                if (questionIsEmpty || answerIsEmpty) { alert('Bitte Frage und Antwort eingeben (Text oder Bild)!'); return; }

                lastGrade = grade;
                lastChapter = chapter;
                const oldMemoBoxData = JSON.parse(JSON.stringify(memoBoxData)); // Für Rollback

                if (!memoBoxData[currentSubject]) memoBoxData[currentSubject] = {};
                if (!memoBoxData[currentSubject][grade]) memoBoxData[currentSubject][grade] = {};
                if (!memoBoxData[currentSubject][grade][chapter]) memoBoxData[currentSubject][grade][chapter] = [];

                memoBoxData[currentSubject][grade][chapter].push({
                    questionHTML: questionHTML, answerHTML: answerHTML,
                    id: Date.now() + '-' + Math.random().toString(36).substr(2, 9)
                });

                const savedToServer = await saveMemoBoxDataToServer(); // Ruft jetzt intern KEIN Passwort ab

                if (savedToServer) {
                    document.getElementById('question-editor').innerHTML = '';
                    document.getElementById('answer-editor').innerHTML = '';
                    document.getElementById('question-editor').focus();
                } else {
                    memoBoxData = oldMemoBoxData; // Rollback bei Fehler
                }
            });

            // --- Aussteigen (Eintragen) ---
            document.getElementById('btn-exit-add').addEventListener('click', () => showSection('action-selection'));

            // --- Bearbeiten Button ---
            document.getElementById('btn-edit').addEventListener('click', function() {
                 if (!isTeacherLoggedIn()) {
                    if (!attemptTeacherLogin()) { return; } // Login versuchen
                 }
                // Nur wenn eingeloggt:
                if (!currentSubject || !memoBoxData[currentSubject] || Object.keys(memoBoxData[currentSubject]).length === 0) {
                    showFeedback(`Keine Einträge für "${currentSubject}" vorhanden.`, "info"); return;
                }
                displayEditGradeSelection();
                showSection('edit-grade-selection');
            });

            // --- Navigation Bearbeiten ---
            document.getElementById('btn-back-to-actions-from-edit-grade').addEventListener('click', () => showSection('action-selection'));
            document.getElementById('btn-back-to-edit-grades').addEventListener('click', () => { displayEditGradeSelection(); showSection('edit-grade-selection'); });
            document.getElementById('btn-back-to-edit-chapters').addEventListener('click', () => { displayEditChapterSelection(selectedEditGrade); showSection('edit-chapter-selection'); });
            document.getElementById('btn-cancel-edit').addEventListener('click', () => { displayEditQuestionSelection(selectedEditGrade, selectedEditChapter); showSection('edit-question-selection'); currentEditingCard = null; });

            // --- Änderungen Speichern Button ---
            document.getElementById('btn-save-changes').addEventListener('click', async function() {
                 if (!isTeacherLoggedIn()) { showFeedback("Nicht eingeloggt.", "error"); return; }
                 if (!currentEditingCard) return;
                 // ... (Validierung wie vorher) ...
                 const newGrade = document.getElementById('edit-grade').value.trim();
                 const newChapter = document.getElementById('edit-chapter').value.trim();
                 const newQuestionHTML = getEditorContentHTML('edit-question-editor');
                 const newAnswerHTML = getEditorContentHTML('edit-answer-editor');
                 if (!newGrade || !newChapter /*... weitere Validierung ...*/) { /*...*/ return; }

                 const oldMemoBoxData = JSON.parse(JSON.stringify(memoBoxData)); // Für Rollback
                 let cardFoundAndUpdatedLocally = false;
                 try {
                    // ... (Logik zum lokalen Ändern/Verschieben der Karte wie vorher) ...
                    const originalGrade = originalCardLocation.grade;
                    const originalChapter = originalCardLocation.chapter;
                    const cardId = currentEditingCard.id;
                    const chapterArray = memoBoxData[currentSubject]?.[originalGrade]?.[originalChapter];
                    if (!chapterArray) throw new Error("Original chapter not found");
                    const cardIndex = chapterArray.findIndex(card => card.id === cardId);
                    if (cardIndex === -1) throw new Error("Original card not found");
                    const updatedCard = { ...chapterArray[cardIndex], questionHTML: newQuestionHTML, answerHTML: newAnswerHTML };
                    if (newGrade === originalGrade && newChapter === originalChapter) {
                        chapterArray[cardIndex] = updatedCard;
                    } else {
                        chapterArray.splice(cardIndex, 1);
                        cleanupEmptyStructures(currentSubject, originalGrade, originalChapter);
                        if (!memoBoxData[currentSubject][newGrade]) memoBoxData[currentSubject][newGrade] = {};
                        if (!memoBoxData[currentSubject][newGrade][newChapter]) memoBoxData[currentSubject][newGrade][newChapter] = [];
                        memoBoxData[currentSubject][newGrade][newChapter].push(updatedCard);
                    }
                    cardFoundAndUpdatedLocally = true;
                 } catch (error) { /*...*/ memoBoxData = oldMemoBoxData; return; }


                 if (cardFoundAndUpdatedLocally) {
                     const savedToServer = await saveMemoBoxDataToServer(); // Ruft jetzt intern KEIN Passwort ab
                     if (savedToServer) {
                         currentEditingCard = null;
                         showSection('action-selection');
                     } else { memoBoxData = oldMemoBoxData; } // Rollback
                 }
            });

            // --- Karte Löschen Button ---
            document.getElementById('btn-delete-card').addEventListener('click', async function() {
                 if (!isTeacherLoggedIn()) { showFeedback("Nicht eingeloggt.", "error"); return; }
                 if (!currentEditingCard || !confirm('Lernkarte wirklich löschen?')) return;

                 const oldMemoBoxData = JSON.parse(JSON.stringify(memoBoxData)); // Für Rollback
                 let cardDeletedLocally = false;
                 try {
                    // ... (Logik zum lokalen Löschen wie vorher) ...
                     const originalGrade = originalCardLocation.grade;
                     const originalChapter = originalCardLocation.chapter;
                     const cardId = currentEditingCard.id;
                     const chapterArray = memoBoxData[currentSubject]?.[originalGrade]?.[originalChapter];
                     if (!chapterArray) throw new Error("Original chapter not found");
                     const cardIndex = chapterArray.findIndex(card => card.id === cardId);
                     if (cardIndex === -1) throw new Error("Card not found");
                     chapterArray.splice(cardIndex, 1);
                     cleanupEmptyStructures(currentSubject, originalGrade, originalChapter);
                     cardDeletedLocally = true;
                 } catch(error) { /*...*/ memoBoxData = oldMemoBoxData; return; }

                  if (cardDeletedLocally) {
                      const savedToServer = await saveMemoBoxDataToServer(); // Ruft jetzt intern KEIN Passwort ab
                      if (savedToServer) {
                         currentEditingCard = null;
                         showSection('action-selection');
                      } else { memoBoxData = oldMemoBoxData; } // Rollback
                  }
             });

            // --- Quiz Sektion ---
            document.getElementById('btn-quiz').addEventListener('click', function() { /* ... unverändert ... */ });
            document.getElementById('btn-back-to-actions-from-quiz-grade').addEventListener('click', () => showSection('action-selection'));
            document.getElementById('btn-back-to-quiz-grades').addEventListener('click', () => { displayQuizGradeSelection(); showSection('quiz-grade-selection'); });
            document.getElementById('btn-quit-quiz').addEventListener('click', () => { if (confirm('Abfrage abbrechen?')) { quizStack = []; showSection('subject-selection'); } });
            document.getElementById('btn-back-to-subjects-after-quiz').addEventListener('click', () => showSection('subject-selection'));
            document.getElementById('btn-show-answer').addEventListener('click', function() { /* ... mit Auto-Scroll wie vorher ... */ });
             // --- Quiz Sektion (Code hier zur Vollständigkeit) ---
             document.getElementById('btn-quiz').addEventListener('click', function() {
                 if (!currentSubject || !memoBoxData[currentSubject] || Object.keys(memoBoxData[currentSubject]).length === 0) {
                     showFeedback(`Keine Einträge für "${currentSubject}" vorhanden.`, "info");
                     return;
                 }
                 displayQuizGradeSelection();
                 showSection('quiz-grade-selection');
             });
             document.getElementById('btn-show-answer').addEventListener('click', function() {
                 if (quizStack.length > 0) {
                      const currentCard = quizStack[0];
                      const answerArea = document.getElementById('quiz-answer-area');
                      displayHTMLContent('quiz-answer', currentCard.answerHTML);
                      answerArea.classList.remove('hidden');
                      document.getElementById('btn-show-answer').classList.add('hidden');
                      document.getElementById('btn-known').classList.remove('hidden');
                      document.getElementById('btn-unknown').classList.remove('hidden');
                      answerArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                 }
             });
            document.getElementById('btn-known').addEventListener('click', function() { if (quizStack.length > 0) { quizStack.shift(); processNextQuizCard(); } });
            document.getElementById('btn-unknown').addEventListener('click', function() { if (quizStack.length > 0) { const card = quizStack.shift(); quizStack.push(card); processNextQuizCard(); } });

        }); // Ende DOMContentLoaded

        // === Fächerbuttons dynamisch erstellen ===
        function displaySubjectButtons() { /* ... unverändert wie vorher ... */ }
         // === Fächerbuttons (Code hier zur Vollständigkeit) ===
         function displaySubjectButtons() {
            const grid = document.getElementById('subject-grid');
            if (!grid) return;
            grid.innerHTML = '';
            const subjects = ["Deutsch", "Mathematik", "Englisch", "Physik", "Chemie", "Biologie", "Geschichte", "Erdkunde", "Ethik", "Kunst", "Musik", "Informatik"];
            subjects.forEach(subjectName => {
                const button = document.createElement('button');
                const className = subjectName.replace(/\s+/g, '').replace(/ä/g, 'ae').replace(/ö/g, 'oe').replace(/ü/g, 'ue').replace(/ß/g, 'ss');
                button.className = `btn subject-btn ${className}`;
                button.textContent = subjectName;
                button.addEventListener('click', function() {
                    currentSubject = this.textContent.trim();
                    document.getElementById('current-subject').textContent = `Fach: ${currentSubject}`;
                    showSection('action-selection');
                });
                grid.appendChild(button);
            });
         }

        // === Funktionen für Bearbeiten/Löschen ===
        function displayEditGradeSelection() { /* ... unverändert wie vorher ... */ }
        function displayEditChapterSelection(grade) { /* ... unverändert wie vorher ... */ }
        function displayEditQuestionSelection(grade, chapter) { /* ... unverändert wie vorher ... */ }
        function loadCardForEditing(grade, chapter, cardId) { /* ... unverändert wie vorher, stellt sicher, dass Editoren bearbeitbar sind wenn eingeloggt */
             const cards = memoBoxData[currentSubject]?.[grade]?.[chapter];
             const cardToEdit = cards?.find(card => card.id === cardId);
             if (cardToEdit) {
                 currentEditingCard = { ...cardToEdit };
                 originalCardLocation = { grade: grade, chapter: chapter };
                 document.getElementById('edit-grade').value = grade;
                 document.getElementById('edit-chapter').value = chapter;
                 // Setze contentEditable basierend auf Login-Status
                 const canEdit = isTeacherLoggedIn();
                 const qEditor = document.getElementById('edit-question-editor');
                 const aEditor = document.getElementById('edit-answer-editor');
                 qEditor.contentEditable = canEdit;
                 aEditor.contentEditable = canEdit;
                 displayHTMLContent('edit-question-editor', cardToEdit.questionHTML);
                 displayHTMLContent('edit-answer-editor', cardToEdit.answerHTML);
                 // Buttons ggf. auch ausblenden/deaktivieren, wenn nicht eingeloggt
                 document.getElementById('btn-save-changes').style.display = canEdit ? '' : 'none';
                 document.getElementById('btn-delete-card').style.display = canEdit ? '' : 'none';
                 document.querySelectorAll('#edit-card .upload-btn').forEach(btn => btn.style.display = canEdit ? '' : 'none');

                 showSection('edit-card');
             } else { /* ... Fehlerbehandlung ... */ }
        }
        // === Funktionen für Bearbeiten/Löschen (Code hier zur Vollständigkeit) ===
         function displayEditGradeSelection() {
             const gradeList = document.getElementById('edit-grades-list');
             gradeList.innerHTML = '';
             const subjectData = memoBoxData[currentSubject];
             const placeholder = '<p class="text-muted text-center" style="grid-column: 1 / -1;">Keine Klassenstufen gefunden.</p>';
             if (!subjectData || Object.keys(subjectData).length === 0) { gradeList.innerHTML = placeholder; return; }
             const grades = Object.keys(subjectData).sort((a,b) => a.localeCompare(b, undefined, {numeric: true}));
             grades.forEach(grade => {
                  if (Object.keys(subjectData[grade]).length > 0 && Object.values(subjectData[grade]).some(chap => chap.length > 0)) {
                      const button = document.createElement('button');
                      button.textContent = grade;
                      button.className = 'btn list-item-btn';
                      button.onclick = () => { selectedEditGrade = grade; displayEditChapterSelection(grade); showSection('edit-chapter-selection'); };
                      gradeList.appendChild(button);
                  }
             });
              if (gradeList.children.length === 0) { gradeList.innerHTML = placeholder; }
         }
         function displayEditChapterSelection(grade) {
             const chapterList = document.getElementById('edit-chapters-list');
             const title = document.getElementById('edit-chapter-selection-title');
             chapterList.innerHTML = '';
             title.textContent = `Bearbeiten (${grade}): Wähle Kapitel`;
             const gradeData = memoBoxData[currentSubject]?.[grade];
              const placeholder = '<p class="text-muted text-center" style="grid-column: 1 / -1;">Keine Kapitel mit Karten gefunden.</p>';
             if (!gradeData || Object.keys(gradeData).length === 0) { chapterList.innerHTML = placeholder; return; }
             const chapters = Object.keys(gradeData).sort();
             chapters.forEach(chapter => {
                  if (gradeData[chapter] && gradeData[chapter].length > 0) {
                      const button = document.createElement('button');
                      button.textContent = `${chapter} (${gradeData[chapter].length} Karten)`;
                      button.className = 'btn list-item-btn';
                      button.onclick = () => { selectedEditChapter = chapter; displayEditQuestionSelection(grade, chapter); showSection('edit-question-selection'); };
                      chapterList.appendChild(button);
                  }
             });
             if (chapterList.children.length === 0) { chapterList.innerHTML = placeholder; }
         }
          function displayEditQuestionSelection(grade, chapter) {
             const questionList = document.getElementById('edit-questions-list');
             const title = document.getElementById('edit-question-selection-title');
             questionList.innerHTML = '';
             title.textContent = `Bearbeiten (${grade} - ${chapter}): Wähle Frage`;
             const cards = memoBoxData[currentSubject]?.[grade]?.[chapter];
             const placeholder = '<p class="text-muted text-center">Keine Fragen gefunden.</p>';
             if (!cards || cards.length === 0) { questionList.innerHTML = placeholder; return; }
              cards.sort((a, b) => (getPlainTextFromHTML(a.questionHTML) || '').localeCompare(getPlainTextFromHTML(b.questionHTML) || ''));
             cards.forEach(card => {
                 const button = document.createElement('button');
                 let previewText = getPlainTextFromHTML(card.questionHTML).substring(0, 100);
                 if (card.questionHTML.includes('<img')) { previewText = "[Bild] " + previewText; }
                 if (previewText.length >= 100) previewText += "...";
                 button.textContent = previewText || "[Leere Frage]";
                 button.title = getPlainTextFromHTML(card.questionHTML);
                 button.className = 'btn question-preview-btn';
                 button.dataset.cardId = card.id;
                 button.onclick = () => { loadCardForEditing(grade, chapter, card.id); };
                 questionList.appendChild(button);
             });
              if (questionList.children.length === 0) { questionList.innerHTML = placeholder; }
         }
         // loadCardForEditing wurde oben schon angepasst


        // === Funktionen für Abfragen ===
        function displayQuizGradeSelection() { /* ... unverändert wie vorher ... */ }
        function displayQuizChapterSelection(grade) { /* ... unverändert wie vorher ... */ }
        function startQuiz() { /* ... unverändert wie vorher ... */ }
        function processNextQuizCard() { /* ... unverändert wie vorher ... */ }
         // === Funktionen für Abfragen (Code hier zur Vollständigkeit) ===
          function displayQuizGradeSelection() {
              const gradeList = document.getElementById('quiz-grades-list');
              gradeList.innerHTML = '';
              const subjectData = memoBoxData[currentSubject];
              const placeholder = '<p class="text-muted text-center" style="grid-column: 1 / -1;">Keine Klassenstufen gefunden.</p>';
              if (!subjectData || Object.keys(subjectData).length === 0) { gradeList.innerHTML = placeholder; return; }
              const grades = Object.keys(subjectData).sort((a,b) => a.localeCompare(b, undefined, {numeric: true}));
              grades.forEach(grade => {
                   if (Object.keys(subjectData[grade]).length > 0 && Object.values(subjectData[grade]).some(chap => chap.length > 0)) {
                       const button = document.createElement('button');
                       button.textContent = grade;
                       button.className = 'btn list-item-btn';
                       button.onclick = () => { selectedQuizGrade = grade; displayQuizChapterSelection(grade); showSection('quiz-chapter-selection'); };
                       gradeList.appendChild(button);
                   }
              });
               if (gradeList.children.length === 0) { gradeList.innerHTML = placeholder; }
          }
          function displayQuizChapterSelection(grade) {
              const chapterList = document.getElementById('quiz-chapters-list');
              const title = document.getElementById('quiz-chapter-selection-title');
              chapterList.innerHTML = '';
              title.textContent = `Abfragen (${grade}): Wähle Kapitel`;
              const gradeData = memoBoxData[currentSubject]?.[grade];
               const placeholder = '<p class="text-muted text-center" style="grid-column: 1 / -1;">Keine Kapitel mit Karten gefunden.</p>';
              if (!gradeData || Object.keys(gradeData).length === 0) { chapterList.innerHTML = placeholder; return; }
              const chapters = Object.keys(gradeData).sort();
              chapters.forEach(chapter => {
                   if (gradeData[chapter] && gradeData[chapter].length > 0) {
                       const button = document.createElement('button');
                       button.textContent = `${chapter} (${gradeData[chapter].length} Karten)`;
                       button.className = 'btn list-item-btn';
                       button.onclick = () => { selectedQuizChapter = chapter; startQuiz(); };
                       chapterList.appendChild(button);
                   }
              });
              if (chapterList.children.length === 0) { chapterList.innerHTML = placeholder; }
          }
          function startQuiz() {
     // Logge die Werte, die wir verwenden wollen
     console.log("Attempting to start quiz with:");
     console.log("  currentSubject:", currentSubject);
     console.log("  selectedQuizGrade:", selectedQuizGrade);
     console.log("  selectedQuizChapter:", selectedQuizChapter);
     console.log("  memoBoxData structure for subject:", memoBoxData[currentSubject]); // Zeige die Daten für das Fach

     // Robuste Prüfung, ob die verschachtelten Daten existieren
     const gradeData = memoBoxData[currentSubject]?.[selectedQuizGrade];
     const cards = gradeData?.[selectedQuizChapter]; // cards ist jetzt das Array oder undefined

     // Jetzt die Prüfung auf cards und cards.length
     // WICHTIG: Prüfe zuerst auf cards selbst, bevor du .length liest!
     if (!cards || !Array.isArray(cards) || cards.length === 0) { // Zusätzliche Prüfung auf Array
         showFeedback("Keine Karten in diesem Kapitel zum Abfragen vorhanden oder Datenfehler.", "info");
         console.error("No cards found or data structure issue. Aborting quiz start. cards:", cards); // Detaillierterer Log
         // Zurück zur Kapitelauswahl springen
         if (selectedQuizGrade) { // Nur wenn eine Note ausgewählt war
              displayQuizChapterSelection(selectedQuizGrade);
              showSection('quiz-chapter-selection');
         } else {
              showSection('action-selection'); // Fallback
         }
         return;
     }

     // --- Ab hier sollte 'cards' ein gültiges, nicht-leeres Array sein ---

     // Kopie erstellen und mischen
     quizStack = shuffleArray([...cards]);
     initialCardCount = quizStack.length;

     // UI zurücksetzen etc.
     document.getElementById('quiz-completion-message').classList.add('hidden');
     // ... (Rest der UI-Reset-Logik) ...

     console.log("Quiz initialized with", initialCardCount, "cards. Showing interface.");
     showSection('quiz-interface');
     processNextQuizCard();
}
function startQuiz() {
     // Logge die Werte, die wir verwenden wollen
     console.log("Attempting to start quiz with:");
     console.log("  currentSubject:", currentSubject);
     console.log("  selectedQuizGrade:", selectedQuizGrade);
     console.log("  selectedQuizChapter:", selectedQuizChapter);
     console.log("  memoBoxData structure for subject:", memoBoxData[currentSubject]); // Zeige die Daten für das Fach

     // Robuste Prüfung, ob die verschachtelten Daten existieren
     const gradeData = memoBoxData[currentSubject]?.[selectedQuizGrade];
     const cards = gradeData?.[selectedQuizChapter]; // cards ist jetzt das Array oder undefined

     // Jetzt die Prüfung auf cards und cards.length
     // WICHTIG: Prüfe zuerst auf cards selbst, bevor du .length liest!
     if (!cards || !Array.isArray(cards) || cards.length === 0) { // Zusätzliche Prüfung auf Array
         showFeedback("Keine Karten in diesem Kapitel zum Abfragen vorhanden oder Datenfehler.", "info");
         console.error("No cards found or data structure issue. Aborting quiz start. cards:", cards); // Detaillierterer Log
         // Zurück zur Kapitelauswahl springen
         if (selectedQuizGrade) { // Nur wenn eine Note ausgewählt war
              displayQuizChapterSelection(selectedQuizGrade);
              showSection('quiz-chapter-selection');
         } else {
              showSection('action-selection'); // Fallback
         }
         return;
     }

     // --- Ab hier sollte 'cards' ein gültiges, nicht-leeres Array sein ---

     // Kopie erstellen und mischen
     quizStack = shuffleArray([...cards]);
     initialCardCount = quizStack.length;

     // UI zurücksetzen etc.
     document.getElementById('quiz-completion-message').classList.add('hidden');
     // ... (Rest der UI-Reset-Logik) ...

     console.log("Quiz initialized with", initialCardCount, "cards. Showing interface.");
     showSection('quiz-interface');
     processNextQuizCard();
}


          function processNextQuizCard() {
              const progressElement = document.getElementById('quiz-progress');
              const questionElement = document.getElementById('quiz-question');
              const answerArea = document.getElementById('quiz-answer-area');
              const answerElement = document.getElementById('quiz-answer');
              const showAnswerBtn = document.getElementById('btn-show-answer');
              const knownBtn = document.getElementById('btn-known');
              const unknownBtn = document.getElementById('btn-unknown');
              const quitBtn = document.getElementById('btn-quit-quiz');
              const backBtn = document.getElementById('btn-back-to-subjects-after-quiz');
              const completionMsg = document.getElementById('quiz-completion-message');

              if (quizStack.length === 0) {
                  questionElement.innerHTML = '';
                  answerArea.classList.add('hidden');
                  progressElement.textContent = `Alle ${initialCardCount} Karten gelernt!`;
                  completionMsg.classList.remove('hidden');
                  showAnswerBtn.classList.add('hidden');
                  knownBtn.classList.add('hidden');
                  unknownBtn.classList.add('hidden');
                  quitBtn.classList.add('hidden');
                  backBtn.classList.remove('hidden');
              } else {
                  const currentCard = quizStack[0];
                  const remainingCards = quizStack.length;
                  const totalCards = initialCardCount;
                  const currentCardNumber = totalCards - remainingCards + 1;
                  progressElement.textContent = `Karte ${currentCardNumber} von ${totalCards} (noch ${remainingCards} zu lernen)`;
                  displayHTMLContent('quiz-question', currentCard.questionHTML);
                  answerArea.classList.add('hidden');
                  answerElement.innerHTML = '';
                  completionMsg.classList.add('hidden');
                   showAnswerBtn.classList.remove('hidden');
                   knownBtn.classList.add('hidden');
                   unknownBtn.classList.add('hidden');
                   quitBtn.classList.remove('hidden');
                   backBtn.classList.add('hidden');
              }
          }

    </script>
</body>
</html>